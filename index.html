<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KoreaAiMap â€” ì„œìš¸ ë„ì‹œë°ì´í„°</title>

  <!-- Tailwind (CDN, ê°„ë‹¨ ë°ëª¨ìš©) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"/>

  <meta name="theme-color" content="#0f172a"/>
  <style>
    html,body,#app,#map{height:100%} body{font-family:Pretendard,system-ui,sans-serif}
    .glass{background:rgba(15,23,42,.6);backdrop-filter:blur(10px) saturate(140%)}
    .chip{font-size:12px;padding:.25rem .5rem;border:1px solid rgba(71,85,105,.5);border-radius:9999px}
    .btn{padding:.5rem .75rem;border:1px solid rgba(71,85,105,.5);border-radius:12px;background:rgba(30,41,59,.6)}
    .btn:hover{background:rgba(51,65,85,.7)}
    .field{padding:.5rem .75rem;border-radius:10px;background:rgba(2,6,23,.6);border:1px solid rgba(51,65,85,.6)}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.35)}
  </style>

  <!-- NAVER Maps JS v3 (+ visualization). ì½œë°±ìœ¼ë¡œ ì´ˆê¸°í™” íƒ€ì´ë° ë³´ì¥ -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=i0l4aehusw&submodules=visualization&callback=initApp"></script>
</head>
<body class="bg-slate-950 text-slate-200">
  <!-- í—¤ë” -->
  <header class="glass border-b border-slate-800/70 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 via-fuchsia-500 to-rose-500"></div>
        <div class="leading-tight">
          <div class="text-sm text-slate-300">Sejong Univ. Capstone</div>
          <h1 class="text-lg font-semibold">KoreaAiMap <span class="text-indigo-300 text-xs align-top">Seoul Citydata</span></h1>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-3 text-sm">
        <div class="chip">ğŸ“ <span id="placeLabel">-</span></div>
        <div class="chip">ğŸ•’ <span id="updatedLabel">-</span></div>
        <div class="chip">â± <span id="latencyLabel">-</span></div>
      </div>
    </div>
  </header>

  <main id="app" class="relative">
    <div id="map"></div>

    <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <section class="absolute left-4 top-4 z-30 glass border border-slate-800/60 rounded-2xl p-3 sm:p-4 shadow-soft w-[min(92vw,460px)]">
      <div class="flex items-center gap-2 mb-2">
        <div class="text-xs text-slate-300">ë„ì‹œë°ì´í„°</div>
        <div class="chip">/reco/v1/citydata</div>
      </div>

      <div class="grid grid-cols-12 gap-2">
        <div class="col-span-6 sm:col-span-5">
          <label for="code" class="block text-xs text-slate-400 mb-1">POI ì½”ë“œ</label>
          <input id="code" class="field w-full" value="POI104" placeholder="ì˜ˆ: POI104"/>
        </div>
        <div class="col-span-6 sm:col-span-7">
          <label for="place" class="block text-xs text-slate-400 mb-1">ì¥ì†Œ(ì„ íƒ)</label>
          <input id="place" class="field w-full" placeholder="ì˜ˆ: ê°•ë‚¨ì—­"/>
        </div>
        <div class="col-span-12 flex items-center gap-2">
          <button id="load" class="btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="locBtn" class="btn">ë‚´ ìœ„ì¹˜ë¡œ</button>
          <span class="text-xs text-slate-400">ìºì‹œ 60ì´ˆ</span>
        </div>
      </div>

      <div id="note" class="mt-3 hidden"></div>
    </section>

    <!-- ìš°í•˜ë‹¨ ì•ˆë‚´ -->
    <aside class="absolute right-4 bottom-4 glass border border-slate-800/60 rounded-2xl p-3 shadow-soft text-[13px] leading-5 z-30">
      <div>ğŸ”— <a class="text-indigo-300 underline" href="https://api.koreaaimap.com/health" target="_blank" rel="noreferrer">API Health</a></div>
      <div>ğŸŒ CORS: <span class="text-slate-300">www.koreaaimap.com</span></div>
      <div>ğŸ§  Infer: <span class="text-slate-300">/infer (HMAC via Worker)</span></div>
    </aside>

    <!-- ë¡œë”© -->
    <div id="spinner" class="hidden absolute inset-0 grid place-items-center z-20">
      <div class="w-12 h-12 border-4 border-slate-700 border-t-indigo-400 rounded-full animate-spin"></div>
    </div>
  </main>

<script>
/* ---------- ìœ í‹¸ ---------- */
const $ = (s)=>document.querySelector(s);
const fmt = (d)=>new Date(d).toLocaleString('ko-KR',{hour:'2-digit',minute:'2-digit'});
const apiBase = 'https://api.koreaaimap.com';
const qp = (o)=>Object.entries(o).filter(([,v])=>v!=null&&v!=='').map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join('&');

function showNote(msg,type='info'){
  const el=$('#note');
  el.className=type==='error'?'mt-3 text-sm text-rose-300 bg-rose-900/30 border border-rose-700/40 rounded-xl p-3'
                             :'mt-3 text-sm text-emerald-300 bg-emerald-900/20 border border-emerald-700/30 rounded-xl p-3';
  el.innerHTML=msg; el.classList.remove('hidden');
}
const hideNote=()=>$('#note').classList.add('hidden');
const setSpin=(on)=>$('#spinner').classList[on?'remove':'add']('hidden');

/* ---------- ì§€ë„/íˆíŠ¸ë§µ ---------- */
let map, heat;

// visualization ì„œë¸Œëª¨ë“ˆì´ ì‹¤ì œë¡œ ë³´ì¼ ë•Œê¹Œì§€ ëŒ€ê¸°(ìµœëŒ€ 2ì´ˆ)
function waitVizReady(timeout=2000){
  return new Promise((resolve,reject)=>{
    const t0=performance.now();
    (function tick(){
      if (window.naver?.maps?.visualization?.HeatMap) return resolve();
      if (performance.now()-t0>timeout) return reject(new Error('Visualization not ready'));
      requestAnimationFrame(tick);
    })();
  });
}

function initMap(){
  map = new naver.maps.Map('map', {
    center:new naver.maps.LatLng(37.5665,126.9780),
    zoom:13, mapDataControl:true, logoControl:false, scaleControl:false,
    zoomControl:true, zoomControlOptions:{position:naver.maps.Position.TOP_RIGHT}
  });
}

// LatLng[] ë³´ì¥
function toLatLngArray(data){
  if(Array.isArray(data)&&data.length>0){
    if(data[0] instanceof naver.maps.LatLng) return data;
    if(data[0] && data[0].location instanceof naver.maps.LatLng){
      return data.map(d=>d.location);
    }
  }
  return [];
}

/* ---------- ë°ëª¨ìš© ì¤‘ì‹¬ì¢Œí‘œ ---------- */
const centerTable={
  'POI104':'37.5483,127.0792','ì–´ë¦°ì´ëŒ€ê³µì›':'37.5483,127.0792',
  'POI014':'37.4981,127.0276','ê°•ë‚¨ì—­':'37.4981,127.0276',
  'POI072':'37.5261,126.9315','ì—¬ì˜ë„':'37.5261,126.9315'
};
function guessCenter(nameOrCode){
  const s=centerTable[nameOrCode]; if(!s) return [37.5665,126.9780];
  const [lat,lng]=s.split(',').map(Number); return [lat,lng];
}
function pickPopulationScore(categories){
  const c=JSON.stringify(categories??{}).toLowerCase();
  const m=c.match(/(congestion|ppltn|population).{0,20}?(\\d{1,3})/);
  return Math.max(20,Math.min(100,m?Number(m[2]):60));
}
function jitter(center,score){
  const [lat,lng]=center||[37.5665,126.9780];
  const n=Math.round(30+score*.7), r=.004+score*.00002, pts=[];
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, d=Math.random()*r;
    pts.push({location:new naver.maps.LatLng(lat+Math.cos(a)*d,lng+Math.sin(a)*d),weight:1+score/25});
  }
  return pts;
}

/* ---------- API ---------- */
async function fetchCityData({code,place}){
  const url=`${apiBase}/reco/v1/citydata?${qp({code,place})}`;
  const t0=performance.now();
  const res=await fetch(url,{cache:'no-store'});
  $('#latencyLabel').textContent=`${Math.round(performance.now()-t0)} ms`;
  let json; try{ json=await res.json(); }catch{ throw new Error('APIê°€ JSONì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'); }
  if(!res.ok){ throw new Error(json?.error?.message||`HTTP ${res.status}`); }
  return json;
}

/* ---------- ì•¡ì…˜ ---------- */
async function loadCity(){
  hideNote(); setSpin(true);
  try{
    const code=$('#code').value.trim(), place=$('#place').value.trim();
    if(!code && !place) throw new Error('POI ì½”ë“œ ë˜ëŠ” ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

    const data=await fetchCityData({code,place});

    const label=data?.place?.name||data?.place?.code||(code||place); $('#placeLabel').textContent=label??'-';
    $('#updatedLabel').textContent=data?.updatedAt?fmt(data.updatedAt):'-';

    const center=guessCenter(label);
    map.setCenter(new naver.maps.LatLng(center[0],center[1])); map.setZoom(15);

    const pop=pickPopulationScore(data?.categories);
    const latlngs=toLatLngArray(jitter(center,pop));

    // ì²« ë¡œë“œì—ì„œ ìƒì„± â†’ ê·¸ ë’¤ì—ëŠ” setDataë§Œ
    if(!heat){
      heat = new naver.maps.visualization.HeatMap({
        map, radius:30, opacity:0.7, dissipating:true, data: latlngs
      });
    }else{
      heat.setData(latlngs);
    }
    showNote(`âœ… <b>${label}</b> ë°ì´í„° ê°±ì‹  ì™„ë£Œ (scoreâ‰ˆ${pop})`,'info');
  }catch(err){
    const msg=String(err?.message||err);
    if(msg.includes('Failed to fetch')){
      showNote('âŒ API í˜¸ì¶œ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬/CORS ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš” (api.koreaaimap.com).','error');
    }else{
      showNote(`âŒ ${msg}`,'error');
    }
    console.error(err);
  }finally{ setSpin(false); }
}

function toMyLocation(){
  if(!('geolocation' in navigator)){
    return showNote('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.','error');
  }
  // Geolocationì€ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸(HTTPS)ì—ì„œë§Œ ë™ì‘. :contentReference[oaicite:4]{index=4}
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const {latitude,longitude}=pos.coords;
      map.setCenter(new naver.maps.LatLng(latitude,longitude)); map.setZoom(15);
    },
    err=>{
      const why={1:'ê¶Œí•œ ê±°ë¶€ë¨',2:'ìœ„ì¹˜ ê²°ì • ë¶ˆê°€',3:'ì‹œê°„ ì´ˆê³¼'}[err.code]||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
      showNote(`í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${why}).`,'error');
    },
    {enableHighAccuracy:false,timeout:8000,maximumAge:30000}
  );
}

/* ---------- ë¡œë” ì½œë°± ---------- */
async function initApp(){
  try{
    // visualization ì¤€ë¹„ ì•ˆì „ ëŒ€ê¸°(ë¬¸ì„œìƒ ì½œë°±ì´ë©´ ë¡œë“œ ì™„ë£Œì§€ë§Œ, ì•ˆì „ë§ ì¶”ê°€) :contentReference[oaicite:5]{index=5}
    await waitVizReady(2000);
    initMap();
    $('#load').addEventListener('click', loadCity);
    $('#locBtn').addEventListener('click', toMyLocation);
    $('#code').addEventListener('keydown', e=>e.key==='Enter'&&loadCity());
    $('#place').addEventListener('keydown', e=>e.key==='Enter'&&loadCity());
    hideNote();              // í˜¹ì‹œ ë‚¨ì•„ìˆë˜ ì‹¤íŒ¨ ë°°ë„ˆ ì œê±°
    loadCity();              // ìµœì´ˆ 1íšŒ
  }catch(e){
    showNote('ë„¤ì´ë²„ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.','error');
    console.error(e);
  }
}
</script>
</body>
</html>
