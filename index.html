<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KoreaAiMap — 서울 도시데이터</title>

  <!-- Tailwind (CDN, 간단 데모용) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"/>

  <meta name="theme-color" content="#0f172a"/>
  <style>
    html,body,#app,#map{height:100%} body{font-family:Pretendard,system-ui,sans-serif}
    .glass{background:rgba(15,23,42,.6);backdrop-filter:blur(10px) saturate(140%)}
    .chip{font-size:12px;padding:.25rem .5rem;border:1px solid rgba(71,85,105,.5);border-radius:9999px}
    .btn{padding:.5rem .75rem;border:1px solid rgba(71,85,105,.5);border-radius:12px;background:rgba(30,41,59,.6)}
    .btn:hover{background:rgba(51,65,85,.7)}
    .field{padding:.5rem .75rem;border-radius:10px;background:rgba(2,6,23,.6);border:1px solid rgba(51,65,85,.6)}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.35)}
  </style>

  <!-- NAVER Maps JS v3 (+ visualization). 콜백으로 초기화 타이밍 보장 -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=i0l4aehusw&submodules=visualization&callback=initApp"></script>
</head>
<body class="bg-slate-950 text-slate-200">
  <!-- 헤더 -->
  <header class="glass border-b border-slate-800/70 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 via-fuchsia-500 to-rose-500"></div>
        <div class="leading-tight">
          <div class="text-sm text-slate-300">Sejong Univ. Capstone</div>
          <h1 class="text-lg font-semibold">KoreaAiMap <span class="text-indigo-300 text-xs align-top">Seoul Citydata</span></h1>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-3 text-sm">
        <div class="chip">📍 <span id="placeLabel">-</span></div>
        <div class="chip">🕒 <span id="updatedLabel">-</span></div>
        <div class="chip">⏱ <span id="latencyLabel">-</span></div>
      </div>
    </div>
  </header>

  <main id="app" class="relative">
    <div id="map"></div>

    <!-- 컨트롤 패널 -->
    <section class="absolute left-4 top-4 z-30 glass border border-slate-800/60 rounded-2xl p-3 sm:p-4 shadow-soft w-[min(92vw,460px)]">
      <div class="flex items-center gap-2 mb-2">
        <div class="text-xs text-slate-300">도시데이터</div>
        <div class="chip">/reco/v1/citydata</div>
      </div>

      <div class="grid grid-cols-12 gap-2">
        <div class="col-span-6 sm:col-span-5">
          <label for="code" class="block text-xs text-slate-400 mb-1">POI 코드</label>
          <input id="code" class="field w-full" value="POI104" placeholder="예: POI104"/>
        </div>
        <div class="col-span-6 sm:col-span-7">
          <label for="place" class="block text-xs text-slate-400 mb-1">장소(선택)</label>
          <input id="place" class="field w-full" placeholder="예: 강남역"/>
        </div>
        <div class="col-span-12 flex items-center gap-2">
          <button id="load" class="btn">불러오기</button>
          <button id="locBtn" class="btn">내 위치로</button>
          <span class="text-xs text-slate-400">캐시 60초</span>
        </div>
      </div>

      <div id="note" class="mt-3 hidden"></div>
    </section>

    <!-- 우하단 안내 -->
    <aside class="absolute right-4 bottom-4 glass border border-slate-800/60 rounded-2xl p-3 shadow-soft text-[13px] leading-5 z-30">
      <div>🔗 <a class="text-indigo-300 underline" href="https://api.koreaaimap.com/health" target="_blank" rel="noreferrer">API Health</a></div>
      <div>🌐 CORS: <span class="text-slate-300">www.koreaaimap.com</span></div>
      <div>🧠 Infer: <span class="text-slate-300">/infer (HMAC via Worker)</span></div>
    </aside>

    <!-- 로딩 -->
    <div id="spinner" class="hidden absolute inset-0 grid place-items-center z-20">
      <div class="w-12 h-12 border-4 border-slate-700 border-t-indigo-400 rounded-full animate-spin"></div>
    </div>
  </main>

<script>
/* ---------- 유틸 ---------- */
const $ = (s)=>document.querySelector(s);
const fmt = (d)=>new Date(d).toLocaleString('ko-KR',{hour:'2-digit',minute:'2-digit'});
const apiBase = 'https://api.koreaaimap.com';
const qp = (o)=>Object.entries(o).filter(([,v])=>v!=null&&v!=='').map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join('&');

function showNote(msg,type='info'){
  const el=$('#note');
  el.className=type==='error'?'mt-3 text-sm text-rose-300 bg-rose-900/30 border border-rose-700/40 rounded-xl p-3'
                             :'mt-3 text-sm text-emerald-300 bg-emerald-900/20 border border-emerald-700/30 rounded-xl p-3';
  el.innerHTML=msg; el.classList.remove('hidden');
}
const hideNote=()=>$('#note').classList.add('hidden');
const setSpin=(on)=>$('#spinner').classList[on?'remove':'add']('hidden');

/* ---------- 지도/히트맵 ---------- */
let map, heat;

// visualization 서브모듈이 실제로 보일 때까지 대기(최대 2초)
function waitVizReady(timeout=2000){
  return new Promise((resolve,reject)=>{
    const t0=performance.now();
    (function tick(){
      if (window.naver?.maps?.visualization?.HeatMap) return resolve();
      if (performance.now()-t0>timeout) return reject(new Error('Visualization not ready'));
      requestAnimationFrame(tick);
    })();
  });
}

function initMap(){
  map = new naver.maps.Map('map', {
    center:new naver.maps.LatLng(37.5665,126.9780),
    zoom:13, mapDataControl:true, logoControl:false, scaleControl:false,
    zoomControl:true, zoomControlOptions:{position:naver.maps.Position.TOP_RIGHT}
  });
}

// LatLng[] 보장
function toLatLngArray(data){
  if(Array.isArray(data)&&data.length>0){
    if(data[0] instanceof naver.maps.LatLng) return data;
    if(data[0] && data[0].location instanceof naver.maps.LatLng){
      return data.map(d=>d.location);
    }
  }
  return [];
}

/* ---------- 데모용 중심좌표 ---------- */
const centerTable={
  'POI104':'37.5483,127.0792','어린이대공원':'37.5483,127.0792',
  'POI014':'37.4981,127.0276','강남역':'37.4981,127.0276',
  'POI072':'37.5261,126.9315','여의도':'37.5261,126.9315'
};
function guessCenter(nameOrCode){
  const s=centerTable[nameOrCode]; if(!s) return [37.5665,126.9780];
  const [lat,lng]=s.split(',').map(Number); return [lat,lng];
}
function pickPopulationScore(categories){
  const c=JSON.stringify(categories??{}).toLowerCase();
  const m=c.match(/(congestion|ppltn|population).{0,20}?(\\d{1,3})/);
  return Math.max(20,Math.min(100,m?Number(m[2]):60));
}
function jitter(center,score){
  const [lat,lng]=center||[37.5665,126.9780];
  const n=Math.round(30+score*.7), r=.004+score*.00002, pts=[];
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, d=Math.random()*r;
    pts.push({location:new naver.maps.LatLng(lat+Math.cos(a)*d,lng+Math.sin(a)*d),weight:1+score/25});
  }
  return pts;
}

/* ---------- API ---------- */
async function fetchCityData({code,place}){
  const url=`${apiBase}/reco/v1/citydata?${qp({code,place})}`;
  const t0=performance.now();
  const res=await fetch(url,{cache:'no-store'});
  $('#latencyLabel').textContent=`${Math.round(performance.now()-t0)} ms`;
  let json; try{ json=await res.json(); }catch{ throw new Error('API가 JSON을 반환하지 않았습니다'); }
  if(!res.ok){ throw new Error(json?.error?.message||`HTTP ${res.status}`); }
  return json;
}

/* ---------- 액션 ---------- */
async function loadCity(){
  hideNote(); setSpin(true);
  try{
    const code=$('#code').value.trim(), place=$('#place').value.trim();
    if(!code && !place) throw new Error('POI 코드 또는 장소를 입력하세요.');

    const data=await fetchCityData({code,place});

    const label=data?.place?.name||data?.place?.code||(code||place); $('#placeLabel').textContent=label??'-';
    $('#updatedLabel').textContent=data?.updatedAt?fmt(data.updatedAt):'-';

    const center=guessCenter(label);
    map.setCenter(new naver.maps.LatLng(center[0],center[1])); map.setZoom(15);

    const pop=pickPopulationScore(data?.categories);
    const latlngs=toLatLngArray(jitter(center,pop));

    // 첫 로드에서 생성 → 그 뒤에는 setData만
    if(!heat){
      heat = new naver.maps.visualization.HeatMap({
        map, radius:30, opacity:0.7, dissipating:true, data: latlngs
      });
    }else{
      heat.setData(latlngs);
    }
    showNote(`✅ <b>${label}</b> 데이터 갱신 완료 (score≈${pop})`,'info');
  }catch(err){
    const msg=String(err?.message||err);
    if(msg.includes('Failed to fetch')){
      showNote('❌ API 호출 실패: 네트워크/CORS 설정을 확인하세요 (api.koreaaimap.com).','error');
    }else{
      showNote(`❌ ${msg}`,'error');
    }
    console.error(err);
  }finally{ setSpin(false); }
}

function toMyLocation(){
  if(!('geolocation' in navigator)){
    return showNote('이 브라우저는 위치 기능을 지원하지 않습니다.','error');
  }
  // Geolocation은 보안 컨텍스트(HTTPS)에서만 동작. :contentReference[oaicite:4]{index=4}
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const {latitude,longitude}=pos.coords;
      map.setCenter(new naver.maps.LatLng(latitude,longitude)); map.setZoom(15);
    },
    err=>{
      const why={1:'권한 거부됨',2:'위치 결정 불가',3:'시간 초과'}[err.code]||'알 수 없는 오류';
      showNote(`현재 위치를 가져올 수 없습니다 (${why}).`,'error');
    },
    {enableHighAccuracy:false,timeout:8000,maximumAge:30000}
  );
}

/* ---------- 로더 콜백 ---------- */
async function initApp(){
  try{
    // visualization 준비 안전 대기(문서상 콜백이면 로드 완료지만, 안전망 추가) :contentReference[oaicite:5]{index=5}
    await waitVizReady(2000);
    initMap();
    $('#load').addEventListener('click', loadCity);
    $('#locBtn').addEventListener('click', toMyLocation);
    $('#code').addEventListener('keydown', e=>e.key==='Enter'&&loadCity());
    $('#place').addEventListener('keydown', e=>e.key==='Enter'&&loadCity());
    hideNote();              // 혹시 남아있던 실패 배너 제거
    loadCity();              // 최초 1회
  }catch(e){
    showNote('네이버 지도 스크립트를 불러오지 못했습니다.','error');
    console.error(e);
  }
}
</script>
</body>
</html>
