<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KoreaAiMap â€” ì„œìš¸ ë„ì‹œë°ì´í„°</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Pretendard -->
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"/>

  <!-- Naver Maps JS (ì‹œê°í™” ëª¨ë“ˆ í¬í•¨) -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=i0l4aehusw&submodules=visualization"></script>

  <meta name="theme-color" content="#0f172a"/>
  <style>
    :root { --glass: rgba(15,23,42,.6) }
    html,body,#app,#map { height:100% }
    body { font-family: Pretendard, ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", "ë§‘ì€ ê³ ë”•", "Malgun Gothic", "Segoe UI", Roboto, sans-serif }
    .glass { background: var(--glass); backdrop-filter: blur(10px) saturate(140%); }
    .chip { @apply text-xs px-2 py-1 rounded-full border border-slate-600/50; }
    .btn  { @apply px-3 py-2 rounded-xl border border-slate-600/50 bg-slate-800/60 hover:bg-slate-700/70 transition; }
    .field{ @apply px-3 py-2 rounded-lg bg-slate-900/60 border border-slate-700/60 focus:outline-none focus:ring-2 focus:ring-indigo-500; }
    .badge{ @apply text-[11px] px-2 py-[2px] rounded-md bg-indigo-500/20 text-indigo-200; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.35) }
    .fade-in { animation: fade .35s ease-out both }
    @keyframes fade { from {opacity:0; transform: translateY(4px)} to {opacity:1; transform:none} }
  </style>
</head>
<body class="bg-slate-950 text-slate-200">

  <!-- í—¤ë” -->
  <header class="glass border-b border-slate-800/70 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 via-fuchsia-500 to-rose-500"></div>
          <div class="leading-tight">
            <div class="text-sm text-slate-300">Sejong Univ. Capstone</div>
            <h1 class="text-lg font-semibold">KoreaAiMap <span class="badge">Seoul Citydata</span></h1>
          </div>
        </div>

        <!-- ì¢Œí‘œ/ì—…ë°ì´íŠ¸ í‘œì‹œ -->
        <div id="status" class="hidden md:flex items-center gap-3 text-sm">
          <div class="chip">ğŸ“ <span id="placeLabel">-</span></div>
          <div class="chip">ğŸ•’ <span id="updatedLabel">-</span></div>
          <div class="chip">â± <span id="latencyLabel">-</span></div>
        </div>
      </div>
    </div>
  </header>

  <!-- ë³¸ë¬¸ -->
  <main id="app" class="relative">
    <!-- ì§€ë„ -->
    <div id="map"></div>

    <!-- ì¢Œì¸¡ ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <section class="absolute left-4 top-4 z-30 glass border border-slate-800/60 rounded-2xl p-3 sm:p-4 shadow-soft w-[min(92vw,460px)] fade-in">
      <div class="flex items-center gap-2 mb-2">
        <div class="text-xs text-slate-300">ë„ì‹œë°ì´í„°</div>
        <div class="chip">/reco/v1/citydata</div>
      </div>

      <div class="grid grid-cols-12 gap-2">
        <div class="col-span-6 sm:col-span-5">
          <label class="block text-xs text-slate-400 mb-1">POI ì½”ë“œ</label>
          <input id="code" class="field w-full" value="POI104" placeholder="ì˜ˆ: POI104"/>
        </div>
        <div class="col-span-6 sm:col-span-7">
          <label class="block text-xs text-slate-400 mb-1">ì¥ì†Œ(ì„ íƒ)</label>
          <input id="place" class="field w-full" placeholder="ì˜ˆ: ê°•ë‚¨ì—­"/>
        </div>
        <div class="col-span-12 flex items-center gap-2">
          <button id="load" class="btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="locBtn" class="btn">ë‚´ ìœ„ì¹˜ë¡œ</button>
          <span class="text-xs text-slate-400">ìºì‹œ 60ì´ˆ</span>
        </div>
      </div>

      <!-- ì—ëŸ¬/ì•ˆë‚´ -->
      <div id="note" class="mt-3 hidden"></div>
    </section>

    <!-- ìš°í•˜ë‹¨ ì‘ì€ ì¹´ë“œ -->
    <aside class="absolute right-4 bottom-4 glass border border-slate-800/60 rounded-2xl p-3 shadow-soft text-[13px] leading-5 z-30">
      <div>ğŸ”— <a class="text-indigo-300 underline" href="https://api.koreaaimap.com/health" target="_blank" rel="noreferrer">API Health</a></div>
      <div>ğŸŒ CORS: <span class="text-slate-300">www.koreaaimap.com</span></div>
      <div>ğŸ§  Infer: <span class="text-slate-300">/infer (HMAC via Worker)</span></div>
    </aside>

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="spinner" class="hidden absolute inset-0 grid place-items-center z-20">
      <div class="w-12 h-12 border-4 border-slate-700 border-t-indigo-400 rounded-full animate-spin"></div>
    </div>
  </main>

  <script>
  // --------------------- ìœ í‹¸ ---------------------
  const $ = (sel) => document.querySelector(sel);
  const fmt = (d) => new Date(d).toLocaleString('ko-KR', {hour:'2-digit', minute:'2-digit'});
  const apiBase = 'https://api.koreaaimap.com';
  const qp = (obj) => Object.entries(obj).filter(([,v]) => v!=null && v!=='').map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join('&');

  // ì•ˆë‚´/ì—ëŸ¬ ì˜ì—­
  function showNote(html, type='info'){
    const el = $('#note');
    el.className = type==='error'
      ? 'mt-3 text-sm text-rose-300 bg-rose-900/30 border border-rose-700/40 rounded-xl p-3'
      : 'mt-3 text-sm text-emerald-300 bg-emerald-900/20 border border-emerald-700/30 rounded-xl p-3';
    el.innerHTML = html; el.classList.remove('hidden');
  }
  const hideNote = () => $('#note').classList.add('hidden');
  const setSpin = (on) => $('#spinner').classList[on?'remove':'add']('hidden');

  // --------------------- ì§€ë„ ì´ˆê¸°í™” ---------------------
  let map, heat;

  function ensureVizReady() {
    if (!window.naver || !naver.maps) throw new Error('Naver Maps not loaded');
    if (!naver.maps.visualization || !naver.maps.visualization.HeatMap) {
      throw new Error('Visualization submodule not loaded');
    }
  }

  function initMap() {
    ensureVizReady();
    map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­ ê·¼ì²˜
      zoom: 13,
      mapDataControl: true,
      logoControl: false,
      scaleControl: false,
      zoomControl: true,
      zoomControlOptions: { position: naver.maps.Position.TOP_RIGHT }
    });

    heat = new naver.maps.visualization.HeatMap({
      map,
      radius: 30,
      opacity: 0.7,
      dissipating: true
    });
  }

  // ë°ì´í„° í˜•íƒœë¥¼ LatLng[]ë¡œ ê°•ì œ ë³€í™˜
  function toLatLngArray(data) {
    if (Array.isArray(data) && data.length > 0) {
      if (data[0] instanceof naver.maps.LatLng) return data;
      if (data[0] && data[0].location instanceof naver.maps.LatLng) {
        return data.map(d => d.location);
      }
    }
    return [];
  }

  function setHeatData(points) {
    const latlngs = toLatLngArray(points);
    if (!latlngs.length) return;
    heat.setData(latlngs);
  }

  // ì¤‘ì‹¬ ì¢Œí‘œ ì¶”ë¡ (ìƒ˜í”Œ, í•„ìš” ì‹œ 120ê³³ í…Œì´ë¸”ë¡œ í™•ì¥)
  const centerTable = {
    'POI104':'37.5483,127.0792', 'ì–´ë¦°ì´ëŒ€ê³µì›':'37.5483,127.0792',
    'POI014':'37.4981,127.0276', 'ê°•ë‚¨ì—­':'37.4981,127.0276',
    'POI072':'37.5261,126.9315', 'ì—¬ì˜ë„':'37.5261,126.9315'
  };
  function guessCenter(nameOrCode) {
    const s = centerTable[nameOrCode];
    if (!s) return [37.5665,126.9780];
    const [lat,lng] = s.split(',').map(Number);
    return [lat,lng];
  }

  // ì„ì‹œ ê°€ì¤‘ì¹˜ ì¶”ì¶œ(ì‹¤ì œ ìŠ¤í‚¤ë§ˆë¡œ êµì²´í•˜ì„¸ìš”)
  function pickPopulationScore(categories) {
    const c = JSON.stringify(categories ?? {}).toLowerCase();
    const m = c.match(/(congestion|ppltn|population).{0,20}?(\d{1,3})/);
    return Math.max(20, Math.min(100, m ? Number(m[2]) : 60));
  }

  // ì¤‘ì‹¬ ì£¼ë³€ìœ¼ë¡œ ì ì„ í©ë¿Œë ¤ LatLng[]
  function jitter(center, score){
    const [lat,lng] = center || [37.5665,126.9780];
    const n = Math.round(30 + score * 0.7);
    const r = 0.004 + score*0.00002;
    const pts = [];
    for(let i=0;i<n;i++){
      const a = Math.random()*Math.PI*2, d = Math.random()*r;
      const p = new naver.maps.LatLng(lat + Math.cos(a)*d, lng + Math.sin(a)*d);
      pts.push({ location: p, weight: 1 + score/25 });
    }
    return pts;
  }

  // --------------------- API ---------------------
  async function fetchCityData({code, place}) {
    const url = `${apiBase}/reco/v1/citydata?${qp({code, place})}`;
    const t0 = performance.now();
    const res = await fetch(url, { cache: 'no-store' });
    const elapsed = Math.round(performance.now() - t0);
    $('#latencyLabel').textContent = `${elapsed} ms`;
    let json;
    try { json = await res.json(); } catch { throw new Error('Invalid JSON from API'); }
    if (!res.ok) {
      const msg = json?.error?.message || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }

  async function loadCity() {
    hideNote(); setSpin(true);
    try {
      const code = $('#code').value.trim();
      const place = $('#place').value.trim();
      if (!code && !place) throw new Error('POI ì½”ë“œ ë˜ëŠ” ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

      const data = await fetchCityData({code, place});
      // place/updatedAt/categories í‘œì¤€ ì‘ë‹µì„ ì‚¬ìš©
      const label = data?.place?.name || data?.place?.code || (code || place);
      $('#placeLabel').textContent = label ?? '-';
      $('#updatedLabel').textContent = data?.updatedAt ? fmt(data.updatedAt) : '-';

      const center = guessCenter(label);
      if (center) {
        map.setCenter(new naver.maps.LatLng(center[0], center[1]));
        map.setZoom(15);
      }

      const pop = pickPopulationScore(data?.categories);
      const pts = jitter(center, pop);
      setHeatData(pts);

      showNote(`âœ… <b>${label}</b> ë°ì´í„° ê°±ì‹  ì™„ë£Œ (scoreâ‰ˆ${pop})`, 'info');
    } catch (err) {
      console.error(err);
      showNote(`âŒ ${err.message}`, 'error');
    } finally {
      setSpin(false);
    }
  }

  function toMyLocation(){
    if (!navigator.geolocation) return showNote('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
    navigator.geolocation.getCurrentPosition(pos => {
      const {latitude, longitude} = pos.coords;
      map.setCenter(new naver.maps.LatLng(latitude, longitude));
      map.setZoom(15);
    }, _ => showNote('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'));
  }

  // --------------------- ë¶€íŠ¸ìŠ¤íŠ¸ë© ---------------------
  window.addEventListener('DOMContentLoaded', () => {
    try { initMap(); } catch(e) { showNote('ë„¤ì´ë²„ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error'); console.error(e); return; }
    $('#load').addEventListener('click', loadCity);
    $('#locBtn').addEventListener('click', toMyLocation);
    $('#code').addEventListener('keydown', e => e.key==='Enter' && loadCity());
    $('#place').addEventListener('keydown', e => e.key==='Enter' && loadCity());
    loadCity(); // ìµœì´ˆ ë¡œë“œ(ê¸°ë³¸ê°’: POI104)
  });
  </script>
</body>
</html>
